-- @path Families=/Families2Persons/Families.ecore
-- @path Persons=/Families2Persons/Persons.ecore

module Families2Persons;
create OUT : Persons from IN : Families;

-- Context helper to determine family name for any family member
helper context Families!Member def: familyName : String =
	if not self.familyFather.oclIsUndefined() then
		self.familyFather.lastName
	else
		if not self.familyMother.oclIsUndefined() then
			self.familyMother.lastName
		else
			if not self.familySon.oclIsUndefined() then
				self.familySon.lastName
			else
				self.familyDaughter.lastName
			endif
		endif
	endif;

-- Context helper to determine if a member is female
helper context Families!Member def: isFemale() : Boolean =
	if not self.familyMother.oclIsUndefined() then
		true
	else
		if not self.familyDaughter.oclIsUndefined() then
			true
		else
			false
		endif
	endif;

-- Context helper to get full name with family name
helper context Families!Member def: getFullName() : String =
	self.firstName + ' ' + self.familyName;

-- Context-free helper to validate name format
helper def: isValidName(name : String) : Boolean =
	not name.oclIsUndefined() and name.size() > 0;

-- Matched rule to transform male family members to Male persons
rule Member2Male {
	from
		s : Families!Member (not s.isFemale() and isValidName(s.firstName))
	to
		t : Persons!Male (
			fullName <- s.getFullName(),
			age <- if s.age.oclIsUndefined() then 0 else s.age endif
		)
}

-- Matched rule to transform female family members to Female persons
rule Member2Female {
	from
		s : Families!Member (s.isFemale() and isValidName(s.firstName))
	to
		t : Persons!Female (
			fullName <- s.getFullName(),
			age <- if s.age.oclIsUndefined() then 0 else s.age endif
		)
}

-- Called rule to create a person with specific attributes
rule CreatePerson(firstName : String, lastName : String, isFemale : Boolean) {
	to
		p : Persons!Person (
			fullName <- firstName + ' ' + lastName,
			age <- 0
		)
}

-- Helper to count total family members
helper def: countAllMembers() : Integer =
	Families!Member.allInstances()->size();

-- Helper to get all adult members
helper def: getAdultMembers() : Sequence(Families!Member) =
	Families!Member.allInstances()->select(m | not m.age.oclIsUndefined() and m.age >= 18);

-- Test query to validate transformation
query TotalMembers = countAllMembers();

query AdultMembersCount = getAdultMembers()->size();
